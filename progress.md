Original prompt: Implement a browser gameboy emulator that can load and play roms

## 2026-02-23

- Created Vite + TypeScript project skeleton in an empty repository.
- Added planned folder structure for emulator core, runtime, UI, and tests.
- Next: implement CPU/MMU/timer/interrupt/cartridge core with ROM+MBC1 support.
- Implemented core emulator modules: CPU (full opcode matrix + CB ops), MMU/bus, timer, interrupts, serial stub, joypad, PPU, cartridge parser, ROM-only and MBC1 mappers.
- Implemented browser runtime/UI: canvas renderer, controls, debug pane, keyboard + gamepad input, deterministic `window.advanceTime(ms)`, and `window.render_game_to_text()` state export.
- Added save manager with automatic localStorage persistence by SHA-1 ROM hash.
- Added unit tests (CPU, timer, MBC1), compatibility test harness (blargg subset), Playwright smoke test, and ROM fetch script.
- Validation pass: `npm run build`, `npm run test:unit`, `npm run test:compat` (ROM-dependent tests skipped without assets), and `npm run test:e2e` all completed successfully.
- Next TODO: run compatibility tests against downloaded blargg ROMs and tune timing/PPU edge cases based on failures.
- Ran the develop-web-game Playwright client against `http://127.0.0.1:5173`, inspected generated screenshots/state output, and fixed no-ROM stepping behavior so deterministic hooks no longer advance CPU state before a ROM is loaded.
- Added ignore rules for Playwright and web-game test artifacts.
- Ran `./scripts/fetch_test_roms.sh` and executed blargg subset.
- Fixed critical CPU bug in `JR` (`0x18`) where PC-relative offset was computed from pre-immediate PC due expression evaluation order.
- Upgraded compatibility harness:
  - per-ROM cycle budgets for long-running tests (e.g., `cpu_instrs`),
  - dedicated `halt_bug` completion check using framebuffer hash + stable loop verification.
- Implemented targeted timer-cycle alignment for memory-access-sensitive opcodes by introducing controlled early timer ticking inside CPU execution and compensating timer ticks in system stepping.
- Verified mem access timings against individual blargg ROMs: `01-read_timing`, `02-write_timing`, `03-modify_timing` now pass.
- Current validation status:
  - `npm run build` passes,
  - `npm run test:unit` passes,
  - `npm run test:compat` passes (`cpu_instrs`, `instr_timing`, `mem_timing`, `halt_bug`),
  - `npm run test:e2e` passes.
- Investigated keyboard-unresponsive Tetris title/menu flow with browser + core traces.
- Root cause found in serial stub semantics: transfers were auto-completing for `SC=0x80` (external clock) and RX data echoed TX byte, which breaks Tetris menu/link detection logic.
- Fixed `Serial` behavior:
  - auto-complete only when `SC` has start+internal clock (`0x81`),
  - on completion in disconnected-link mode, RX byte now becomes `0xFF`,
  - preserve transmitted byte in serial output log for blargg diagnostics.
- Added `tests/unit/serial.test.ts` covering internal-clock completion + interrupt and external-clock non-completion.
- Revalidated:
  - `npm run test:unit` passes,
  - `npm run test:compat` passes,
  - `npm run build` passes.
- Manual browser verification with `tests/roms/tetris.gb`:
  - keyboard `Enter` now advances from title `1 PLAYER / 2 PLAYER` to subsequent menus (`GAME TYPE / MUSIC TYPE`, then `B-TYPE` level screen).

## 2026-02-24

- Continued DMG Tier-1 compatibility sweep implementation and validation.
- Confirmed Tier-1 compat harness expansion is in place:
  - `tests/compat/mooneye.compat.test.ts` for required mooneye acceptance ROMs,
  - `tests/compat/compatTypes.ts` with `CompatResult` shape (`name`, `status`, `cycles`, `pc`, `opcode`, `bc/de/hl`, `serialTail`),
  - `scripts/fetch_test_roms.sh` pinned mooneye bundle fetch/extract.
- Confirmed non-breaking debug/test surfacing is in place:
  - `window.render_game_to_text()` payload includes `frame_hash` and `compat_flags`,
  - deterministic `window.advanceTime(ms)` remains available.
- Removed temporary debug artifact `tests/unit/_tetris_debug.test.ts` to keep unit suite clean.
- Hardened optional local Tetris smoke test `tests/e2e/tetris.local.spec.ts`:
  - switched from wall-clock waits to deterministic `advanceTime` stepping,
  - added deterministic key-hold input helper,
  - updated startup/menu traversal sequence to reliably reach gameplay,
  - added bounded fallback progression before asserting frame dynamics.
- Validation pass completed:
  - `npm run -s test:unit` ✅
  - `npm run -s test:compat` ✅ (blargg subset + mooneye Tier-1 required set)
  - `npm run -s test:e2e -- tests/e2e/tetris.local.spec.ts` ✅ (with local `tests/roms/tetris.gb`)
  - `npm run -s build` ✅
- Additional browser sanity check via develop-web-game Playwright client:
  - generated `output/web-game/shot-*.png` and `state-*.json`,
  - verified no console/page errors in generated artifacts.
- Added GitHub Actions CI workflow at `.github/workflows/ci.yml`:
  - `Build + Unit + Compat` job runs `npm ci`, `npm run build`, and `npm run test`.
  - `E2E Smoke` job installs Playwright Chromium and runs `npm run test:e2e`.
  - Uploads Playwright artifacts (`test-results`, `playwright-report`) for debugging.
- Updated README test section with CI behavior and ROM-asset skip semantics.
- Local validation after CI add:
  - `actionlint` passes,
  - `npm run -s build` passes,
  - `npm run -s test` passes,
  - `npm run -s test:e2e` passes.
- Added Prettier tooling:
  - installed `prettier` as a dev dependency,
  - added scripts `npm run format` and `npm run format:check`,
  - added project config `.prettierrc.json` and `.prettierignore`,
  - integrated `npm run format:check` into CI build/test job.
- Ran one-time formatting pass and revalidated:
  - `npm run -s format:check` passes,
  - `npm run -s build` passes,
  - `npm run -s test` passes,
  - `npm run -s test:e2e` passes.
- Expanded mooneye compatibility harness for tiered gating:
  - added `npm run test:compat:tier1`,
  - added `npm run test:compat:tier2`,
  - updated `npm run test:compat` to run tier1 + tier2 composite gate.
- Tier-2 baseline before edge-case fixes (recorded from first full run) failed:
  - `acceptance/ei_sequence.gb`
  - `acceptance/rapid_di_ei.gb`
  - `acceptance/timer/tima_write_reloading.gb`
  - `acceptance/timer/tma_write_reloading.gb`
  - `acceptance/oam_dma/reg_read.gb`
  - `acceptance/ppu/lcdon_write_timing-GS.gb`
- Implemented compatibility fixes across CPU/timer/PPU/bus:
  - corrected EI/DI delay/cancel behavior and added repeated-EI handling,
  - fixed TIMA/TMA reload-window write semantics,
  - fixed DMA bus blocking exception for `FF46` register reads during active DMA,
  - split PPU OAM/VRAM read vs write gating to satisfy LCD-on write timing edges.
- Added/expanded unit coverage for new edge cases:
  - `tests/unit/cpu.test.ts` (EI/DI sequencing),
  - `tests/unit/timer.test.ts` (reload-window writes).
- Updated CI hard gate:
  - `build_and_compat` now runs `./scripts/fetch_test_roms.sh` before tests,
  - compat tests now execute against fetched OSS assets in GitHub Actions instead of being skipped.
- Tier-2 final verification status:
  - `npm run -s test:compat:tier1` passes,
  - `npm run -s test:compat:tier2` passes (20/20 required mooneye ROMs),
  - `npm run -s test:compat` passes (tier1 + tier2 composite).
- Tier-2 hardening milestone completed:
  - fixed Tier-2 matrix path mismatch for `if_ie_registers.gb` (`acceptance/if_ie_registers.gb`),
  - added strict preflight checks for required ROM assets with actionable absolute-path errors,
  - added explicit soft mode (`GB_COMPAT_STRICT=0`) that keeps skips non-fatal and recorded.
- Added deterministic compatibility artifacts under `test-results/compat/`:
  - `blargg.json`,
  - `mooneye-tier1.json`,
  - `mooneye-tier2.json`,
  - `summary.md` generated by `scripts/compat_report.mjs`.
- Added compat report gate behavior:
  - `npm run test:compat:report` fails in strict mode when any case is skipped/failed/timeout,
  - report also fails when a required suite records zero cases (protects against accidental skip-by-filter regressions).
- Updated script wiring:
  - `npm run test:compat` now defaults to strict zero-skip behavior,
  - `npm run test:compat:soft` allows local execution without all ROM assets,
  - tier selection moved to `GB_COMPAT_TIER=tier1|tier2` to avoid cross-run report clobbering from test-name filtering.
- Updated CI workflow:
  - runs strict compat and compatibility report generation,
  - uploads `test-results/compat/` artifacts for each run (including failures via `if: always()`).
- Tier-3A gate expansion completed:
  - added `GB_COMPAT_TIER=tier3a|tier3b` execution paths and matrices in `tests/compat/mooneye.compat.test.ts`,
  - added scripts `test:compat:tier3a`, `test:compat:tier3b`, `test:compat:extended`,
  - strict `test:compat` now gates on `tier1 + tier2 + tier3a`.
- Tier-3A baseline failure list (before core fixes):
  - `acceptance/add_sp_e_timing.gb`
  - `acceptance/ld_hl_sp_e_timing.gb`
  - `acceptance/call_timing.gb`
  - `acceptance/ret_timing.gb`
- Core fixes landed for Tier-3A:
  - CPU instruction micro-timing cleanup in `src/core/cpu/CPU.ts`:
    - opcode-fetch cycle is now ticked before opcode execution sequencing,
    - corrected `RST` push timing to include internal delay cycle.
  - DMA bus arbitration fix in `src/core/memory/Bus.ts`:
    - when DMA source is VRAM, WRAM/external bus accesses remain available,
    - OAM remains blocked during DMA,
    - blocked OAM reads return `0xFF`,
    - non-OAM blocked reads continue to expose DMA-source bus values.
  - Added regression unit coverage in `tests/unit/cpu.test.ts`:
    - WRAM execution while VRAM-source DMA is active,
    - OAM read returns `0xFF` during active DMA.
- Tier-3A final status:
  - `npm run -s test:compat:tier3a` ✅ (12/12 pass, zero skips in strict run),
  - `npm run -s test:compat` ✅ (strict required gate green with tier1+tier2+tier3a),
  - `npm run -s format:check` ✅
  - `npm run -s build` ✅
  - `npm run -s test:unit` ✅
  - `npm run -s test:compat:report` ✅
  - `npm run -s test:e2e` ✅ (includes local optional `tetris.local` when ROM exists).
- Tier-3B shadow (informational) current snapshot:
  - fails include `oam_dma_start` and three `ppu/intr_2_*` timing ROMs,
  - `acceptance/oam_dma/sources-GS.gb` currently errors with unsupported cartridge type `0x1b` (MBC5), which is out of current DMG v1 cartridge scope.
- Tier-3B shadow-to-green hardening completed for DMG in-scope matrix:
  - removed `acceptance/oam_dma/sources-GS.gb` from required Tier-3B execution and documented it in `TIER3B_EXCLUDED_CASES` with MBC5 exclusion reason,
  - kept strict required gate unchanged (`tier1 + tier2 + tier3a`) and kept Tier-3B non-blocking shadow in CI.
- DMA/PPU timing fixes landed for Tier-3B:
  - bus DMA blocking now tracks restart-pending state and uses a dedicated `isDmaBlockingActive()` gate for CPU/OAM restrictions,
  - PPU CPU-visible mode reads and OAM readability now apply a 4-cycle mode visibility delay only in mode-2-IRQ timing paths (`STAT bit5` enabled), preserving LCD-on Tier-1 behavior.
- Added unit timing coverage:
  - `tests/unit/bus.test.ts` for fresh DMA start and restart source-switch behavior,
  - `tests/unit/ppu.test.ts` for mode2->mode3, mode3->mode0, and next-line OAM blocking transition edge.
- Validation status after hardening:
  - `npm run -s format:check` ✅
  - `npm run -s build` ✅
  - `npm run -s test:unit` ✅
  - `npm run -s test:compat` ✅ (strict required suites)
  - `npm run -s test:compat:tier3b` ✅ (11/11 shadow cases)
  - `npm run -s test:e2e` ✅
- Tier-3B shadow run streak (mainline promotion tracker):
  - current: 1/3 green runs (local baseline for this milestone)
  - promotion trigger unchanged: 3 consecutive green Tier-3B shadow runs on `main`.
- Mapper expansion milestone (MBC3 basic RTC v1 + MBC5) completed:
  - baseline preserved: strict required gate `tier1 + tier2 + tier3a` remains green with zero regressions.
  - cartridge parser/types expanded in `header.ts` for MBC3 family (`0x0F-0x13`) and MBC5 family (`0x19-0x1E`).
  - new mapper implementations:
    - `src/core/cartridge/mbc/MBC3.ts` with ROM/RAM banking, RTC register select/latch/halt/day-carry, and metadata import/export.
    - `src/core/cartridge/mbc/MBC5.ts` with 9-bit ROM banking, RAM banking/gating, rumble-side-effect no-op behavior.
  - mapper plumbing integrated in `Cartridge.ts`, and non-breaking metadata access added through `GameBoy.ts`.
- Save persistence upgraded to versioned payloads:
  - `SaveManager` now reads legacy v1 base64 SRAM entries and writes v2 JSON (`version`, `ram_b64`, `mapper_meta`).
  - `App.ts` load/reset/flush flows now import/export mapper metadata when present.
  - added `tests/unit/saveManager.test.ts` for v1 backward compatibility and v2 round-trip coverage.
- Compatibility harness and assets expanded:
  - `scripts/fetch_test_roms.sh` now fetches mapper ROM assets to `tests/roms/mapper`:
    - `MBC3_Test.gbc` (ZoomTen/mbc30test v1.1)
    - `rtc3test.gb` (aaaaaa123456789/rtc3test v004)
    - optional `mbctest.gb` (EricKirschenmann/MBC3-Tester-gb v1.0)
  - added `tests/compat/mapper.compat.test.ts` with:
    - MBC5 mooneye emulator-only oracle matrix,
    - MBC3 deterministic smoke for `MBC3_Test.gbc`,
    - informational shadow runs for `rtc3test.gb` and optional `mbctest.gb`.
  - package scripts added:
    - `test:compat:mapper:shadow`
    - `test:compat:mapper:strict`
- Tier3B and DMA alignment updates:
  - moved `acceptance/oam_dma/sources-GS.gb` into executed Tier-3B matrix (`tests/compat/mooneye.compat.test.ts`).
  - fixed DMG DMA source quirk in `Bus.ts`: DMA source addresses `FE00-FFFF` mirror to `DE00-DFFF`.
  - added regression unit coverage in `tests/unit/bus.test.ts` for FE/FF DMA source mirroring.
- CI/report integration updates:
  - `.github/workflows/ci.yml` now runs mapper shadow compat step (`continue-on-error: true`).
  - `scripts/compat_report.mjs` now includes mapper shadow report artifacts as informational rows.
  - new report artifacts emitted:
    - `mapper-mbc5-shadow.json`
    - `mapper-mbc3-shadow.json`
- Validation status after mapper milestone:
  - `npm run format:check` ✅
  - `npm run build` ✅
  - `npm run test:unit` ✅
  - `npm run test:compat` ✅ (strict `tier1+tier2+tier3a`)
  - `GB_COMPAT_STRICT=0 npm run test:compat:tier3b` ✅ (includes `acceptance/oam_dma/sources-GS.gb`)
  - `npm run test:compat:mapper:shadow` ✅
  - `npm run test:compat:mapper:strict` ✅
  - `npm run test:compat:report` ✅
  - `npm run test:e2e` ✅
- Shadow run streak tracker (promotion readiness):
  - Tier-3B shadow: 1/3 green runs on `main` (promotion trigger unchanged).
  - Mapper shadow: 1/3 green runs on `main` (new tracker started this milestone).
- Browser loop sanity via develop-web-game Playwright client:
  - ran `web_game_playwright_client.js` against `http://127.0.0.1:5173` with action payloads,
  - inspected `output/web-game/shot-1.png` and `output/web-game/state-1.json`,
  - no new console/page errors observed from the client run.
