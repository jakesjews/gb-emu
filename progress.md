Original prompt: Implement a browser gameboy emulator that can load and play roms

## 2026-02-23

- Created Vite + TypeScript project skeleton in an empty repository.
- Added planned folder structure for emulator core, runtime, UI, and tests.
- Next: implement CPU/MMU/timer/interrupt/cartridge core with ROM+MBC1 support.
- Implemented core emulator modules: CPU (full opcode matrix + CB ops), MMU/bus, timer, interrupts, serial stub, joypad, PPU, cartridge parser, ROM-only and MBC1 mappers.
- Implemented browser runtime/UI: canvas renderer, controls, debug pane, keyboard + gamepad input, deterministic `window.advanceTime(ms)`, and `window.render_game_to_text()` state export.
- Added save manager with automatic localStorage persistence by SHA-1 ROM hash.
- Added unit tests (CPU, timer, MBC1), compatibility test harness (blargg subset), Playwright smoke test, and ROM fetch script.
- Validation pass: `npm run build`, `npm run test:unit`, `npm run test:compat` (ROM-dependent tests skipped without assets), and `npm run test:e2e` all completed successfully.
- Next TODO: run compatibility tests against downloaded blargg ROMs and tune timing/PPU edge cases based on failures.
- Ran the develop-web-game Playwright client against `http://127.0.0.1:5173`, inspected generated screenshots/state output, and fixed no-ROM stepping behavior so deterministic hooks no longer advance CPU state before a ROM is loaded.
- Added ignore rules for Playwright and web-game test artifacts.
- Ran `./scripts/fetch_test_roms.sh` and executed blargg subset.
- Fixed critical CPU bug in `JR` (`0x18`) where PC-relative offset was computed from pre-immediate PC due expression evaluation order.
- Upgraded compatibility harness:
  - per-ROM cycle budgets for long-running tests (e.g., `cpu_instrs`),
  - dedicated `halt_bug` completion check using framebuffer hash + stable loop verification.
- Implemented targeted timer-cycle alignment for memory-access-sensitive opcodes by introducing controlled early timer ticking inside CPU execution and compensating timer ticks in system stepping.
- Verified mem access timings against individual blargg ROMs: `01-read_timing`, `02-write_timing`, `03-modify_timing` now pass.
- Current validation status:
  - `npm run build` passes,
  - `npm run test:unit` passes,
  - `npm run test:compat` passes (`cpu_instrs`, `instr_timing`, `mem_timing`, `halt_bug`),
  - `npm run test:e2e` passes.
- Investigated keyboard-unresponsive Tetris title/menu flow with browser + core traces.
- Root cause found in serial stub semantics: transfers were auto-completing for `SC=0x80` (external clock) and RX data echoed TX byte, which breaks Tetris menu/link detection logic.
- Fixed `Serial` behavior:
  - auto-complete only when `SC` has start+internal clock (`0x81`),
  - on completion in disconnected-link mode, RX byte now becomes `0xFF`,
  - preserve transmitted byte in serial output log for blargg diagnostics.
- Added `tests/unit/serial.test.ts` covering internal-clock completion + interrupt and external-clock non-completion.
- Revalidated:
  - `npm run test:unit` passes,
  - `npm run test:compat` passes,
  - `npm run build` passes.
- Manual browser verification with `tests/roms/tetris.gb`:
  - keyboard `Enter` now advances from title `1 PLAYER / 2 PLAYER` to subsequent menus (`GAME TYPE / MUSIC TYPE`, then `B-TYPE` level screen).

## 2026-02-24

- Continued DMG Tier-1 compatibility sweep implementation and validation.
- Confirmed Tier-1 compat harness expansion is in place:
  - `tests/compat/mooneye.compat.test.ts` for required mooneye acceptance ROMs,
  - `tests/compat/compatTypes.ts` with `CompatResult` shape (`name`, `status`, `cycles`, `pc`, `opcode`, `bc/de/hl`, `serialTail`),
  - `scripts/fetch_test_roms.sh` pinned mooneye bundle fetch/extract.
- Confirmed non-breaking debug/test surfacing is in place:
  - `window.render_game_to_text()` payload includes `frame_hash` and `compat_flags`,
  - deterministic `window.advanceTime(ms)` remains available.
- Removed temporary debug artifact `tests/unit/_tetris_debug.test.ts` to keep unit suite clean.
- Hardened optional local Tetris smoke test `tests/e2e/tetris.local.spec.ts`:
  - switched from wall-clock waits to deterministic `advanceTime` stepping,
  - added deterministic key-hold input helper,
  - updated startup/menu traversal sequence to reliably reach gameplay,
  - added bounded fallback progression before asserting frame dynamics.
- Validation pass completed:
  - `npm run -s test:unit` ✅
  - `npm run -s test:compat` ✅ (blargg subset + mooneye Tier-1 required set)
  - `npm run -s test:e2e -- tests/e2e/tetris.local.spec.ts` ✅ (with local `tests/roms/tetris.gb`)
  - `npm run -s build` ✅
- Additional browser sanity check via develop-web-game Playwright client:
  - generated `output/web-game/shot-*.png` and `state-*.json`,
  - verified no console/page errors in generated artifacts.
- Added GitHub Actions CI workflow at `.github/workflows/ci.yml`:
  - `Build + Unit + Compat` job runs `npm ci`, `npm run build`, and `npm run test`.
  - `E2E Smoke` job installs Playwright Chromium and runs `npm run test:e2e`.
  - Uploads Playwright artifacts (`test-results`, `playwright-report`) for debugging.
- Updated README test section with CI behavior and ROM-asset skip semantics.
- Local validation after CI add:
  - `actionlint` passes,
  - `npm run -s build` passes,
  - `npm run -s test` passes,
  - `npm run -s test:e2e` passes.
- Added Prettier tooling:
  - installed `prettier` as a dev dependency,
  - added scripts `npm run format` and `npm run format:check`,
  - added project config `.prettierrc.json` and `.prettierignore`,
  - integrated `npm run format:check` into CI build/test job.
- Ran one-time formatting pass and revalidated:
  - `npm run -s format:check` passes,
  - `npm run -s build` passes,
  - `npm run -s test` passes,
  - `npm run -s test:e2e` passes.
- Expanded mooneye compatibility harness for tiered gating:
  - added `npm run test:compat:tier1`,
  - added `npm run test:compat:tier2`,
  - updated `npm run test:compat` to run tier1 + tier2 composite gate.
- Tier-2 baseline before edge-case fixes (recorded from first full run) failed:
  - `acceptance/ei_sequence.gb`
  - `acceptance/rapid_di_ei.gb`
  - `acceptance/timer/tima_write_reloading.gb`
  - `acceptance/timer/tma_write_reloading.gb`
  - `acceptance/oam_dma/reg_read.gb`
  - `acceptance/ppu/lcdon_write_timing-GS.gb`
- Implemented compatibility fixes across CPU/timer/PPU/bus:
  - corrected EI/DI delay/cancel behavior and added repeated-EI handling,
  - fixed TIMA/TMA reload-window write semantics,
  - fixed DMA bus blocking exception for `FF46` register reads during active DMA,
  - split PPU OAM/VRAM read vs write gating to satisfy LCD-on write timing edges.
- Added/expanded unit coverage for new edge cases:
  - `tests/unit/cpu.test.ts` (EI/DI sequencing),
  - `tests/unit/timer.test.ts` (reload-window writes).
- Updated CI hard gate:
  - `build_and_compat` now runs `./scripts/fetch_test_roms.sh` before tests,
  - compat tests now execute against fetched OSS assets in GitHub Actions instead of being skipped.
- Tier-2 final verification status:
  - `npm run -s test:compat:tier1` passes,
  - `npm run -s test:compat:tier2` passes (20/20 required mooneye ROMs),
  - `npm run -s test:compat` passes (tier1 + tier2 composite).
